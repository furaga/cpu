## -*- coding: utf-8 -*-
<%inherit file="skeleton.tmp"/>

entity mem_acc is
<%include file="mem_acc_entity.tmp"/>
end mem_acc;

architecture behavior of mem_acc is
	component ram is
	<%include file="ram_entity.tmp"/>
	end component;

	signal io_write : std_logic := '0';
	signal io_read : std_logic := '0';
	signal io_en : std_logic;
	signal io_in_keep : ${oc.reg_t()};
	signal wea: std_logic_vector(0 downto 0) := "0";
	signal addra : ${oc.ram_sim_t()};
	signal douta : ${oc.ir_t()};
	signal dina  : ${oc.ir_t()};

begin
	bram : ram port map (CLK2X, wea, addra, dina, douta);

	-- ADDR(0) byte or word
	io_en <= ADDR(19);
	DATA_OUT <= io_in_keep when io_read='1' else douta;

	addra <= ADDR(13 downto 2);
	dina  <= DATA_IN;

	io_read  <= io_en and (not RAM_WEN);
	io_write <= io_en and RAM_WEN;
	wea(0)	<= (not io_en) and RAM_WEN;

	process(CLK_MA)
	begin
		if rising_edge(CLK_MA) then
		-- for debug
			if io_en='1' and RAM_WEN='1' then
				IO_OUT <= x"000000"&DATA_IN(7 downto 0);
			elsif io_en='1' and RAM_WEN='0' then
				io_in_keep <= IO_IN;
			end if;
		end if;
	end process;

	process (CLK2X, clk_ma, io_write, io_read)
	begin 
		if rising_edge(CLK2X) then
			if clk_ma='1' then
				IO_WR <= io_write;
				IO_RD <= io_read;
			else
				IO_WR <= '0';
				IO_RD <= '0';
			end if;
		end if;
	end process;

end behavior;
<%namespace name="oc" file="macro.tmp"/>

