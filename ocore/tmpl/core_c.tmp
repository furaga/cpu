## -*- coding: utf-8 -*-
<%inherit file="skeleton.tmp"/>
entity core_c is
<%include file="core_c_entity.tmp"/>
end core_c;
architecture RTL of core_c is
component clk_gen
<%include file="clk_gen_entity.tmp"/>
end component;
component fetch
<%include file="fetch_entity.tmp"/>
end component;
component decode
<%include file="decode_entity.tmp"/>
end component;
component reg_dc
<%include file="reg_dc_entity.tmp"/>
end component;
component exec
<%include file="exec_entity.tmp"/>
end component;
component reg_wb
<%include file="reg_wb_entity.tmp"/>
end component;
component ram is
<%include file="ram_entity.tmp"/>
end component;

	signal	clk_ft	:	std_logic;
	signal	clk_dc	:	std_logic;
	signal	clk_ex	:	std_logic;
	signal	clk_ma	:	std_logic;
	signal	clk_wb	:	std_logic;

	signal	pc	:	${oc.pc_t()};
	signal	prom_out	:	${oc.ir_t()};
	signal	ir	:	${oc.ir_t()};

	signal	FramePointer	: ${oc.ram_addr_t()};
	signal	N_REG	:	std_logic_vector (4 downto 0);
	signal	REG_IN	:	std_logic_vector (31 downto 0);
	signal	REG_S	:	std_logic_vector (31 downto 0);
	signal	REG_T	:	std_logic_vector (31 downto 0);
	signal	REG_D	:	std_logic_vector (31 downto 0);
	signal	REG_COND	:	std_logic_vector (3 downto 0);
<% num_list = map ((lambda x : '%02d' % x), xrange(32)) %>
%for x in num_list:
	signal	REG_${x}	:	${oc.reg_t()};
%endfor
	signal	RAM_ADDR	:	std_logic_vector (19 downto 0);
	signal	RAM_IN	:	std_logic_vector (31 downto 0);
	signal	RAM_OUT	:	std_logic_vector (31 downto 0);
	signal	ram_wen	:	std_logic;

	signal	LR_IN	:	${oc.pc_t()};
	signal	LR_OUT	:	${oc.pc_t()};
	signal	LinkRegister	:	${oc.pc_t()};

begin			

-- clk(state machine)
	clk_u	:	clk_gen port map(CLK, clk_ft, clk_dc, clk_ex, clk_ma, clk_wb);

-- fetch phase
	fetch_u	:	fetch port map(clk_ft, pc, prom_out);

-- decode phase
	dec_u	:	decode port map(clk_dc, prom_out, REG_01, LR_OUT,
					ir, FramePointer, LinkRegister);
	regdec_rs	:	reg_dc port map(clk_dc, 
		${REGs()}, prom_out(25 downto 21), REG_S);
	regdec_rt	:	reg_dc port map(clk_dc, 
		${REGs()}, prom_out(20 downto 16), REG_T);
	regdec_rd	:	reg_dc port map(clk_dc, 
		${REGs()}, prom_out(15 downto 11), REG_D);

-- exec phase
	exec_u	:	exec port map(clk_ex, RESET, ir, pc,
		 REG_S, REG_T, REG_D, FramePointer, LinkRegister,
		 LR_IN, pc, N_REG, REG_IN, RAM_ADDR, RAM_IN, REG_COND,
		 ram_wen);

	ram_u	: ram port map (clk_ma, ram_wen, RAM_ADDR, RAM_IN,
							RAM_OUT, IO_IN, IO_WR, IO_RD, IO_OUT);
	
-- write back phase
	regwb_u	:	reg_wb port map(clk_wb, RESET,
		 N_REG, REG_IN, LR_IN, RAM_OUT, REG_COND,
		 ${REGs()}, LR_OUT);


end RTL;			
<%namespace name="oc" file="macro.tmp"/>
<%def name="REGs()">
		 REG_00, REG_01, REG_02, REG_03, REG_04, REG_05, REG_06, REG_07, 
		 REG_08, REG_09, REG_10, REG_11, REG_12, REG_13, REG_14, REG_15, 
		 REG_16, REG_17, REG_18, REG_19, REG_20, REG_21, REG_22, REG_23, 
		 REG_24, REG_25, REG_26, REG_27, REG_28, REG_29, REG_30, REG_31
</%def>
